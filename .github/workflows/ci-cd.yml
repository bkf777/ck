# CopilotKit ç»Ÿä¸€ CI/CD Pipeline
# é›†æˆä»£ç è´¨é‡æ£€æŸ¥ã€Dockeræ„å»ºã€å®‰å…¨æ‰«æå’Œè‡ªåŠ¨éƒ¨ç½²
name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
    tags: ["v*"]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      deploy_environment:
        description: "éƒ¨ç½²ç¯å¢ƒ"
        required: true
        default: "staging"
        type: choice
        options:
          - staging
          - production
      force_deploy:
        description: "å¼ºåˆ¶éƒ¨ç½²ï¼ˆè·³è¿‡æ£€æŸ¥ï¼‰"
        required: false
        default: false
        type: boolean
      push_to_registry:
        description: "æ˜¯å¦æ¨é€åˆ°é•œåƒä»“åº“"
        required: false
        default: true
        type: boolean
      deploy_services:
        description: "éƒ¨ç½²çš„æœåŠ¡"
        required: false
        default: "all"
        type: choice
        options:
          - all
          - web
          - agent

permissions:
  contents: read
  security-events: write
  packages: write
  pull-requests: write

env:
  NODE_VERSION: "22.15.1"
  PNPM_VERSION: "9"
  # é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡
  ALIYUN_REGISTRY: crpi-h9er8c2pccoo3ze4.cn-hangzhou.personal.cr.aliyuncs.com
  ALIYUN_NAMESPACE: ez_trading
  WEB_IMAGE_NAME: copilotkit-web
  AGENT_IMAGE_NAME: copilotkit-agent
  DOCKER_BUILDKIT: 1
  # éƒ¨ç½²ç¯å¢ƒURL
  DEPLOY_URL: ${{ secrets.DEPLOY_URL }}
  API_URL: ${{ secrets.API_URL }}

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest

    outputs:
      cache-hit: ${{ steps.cache.outputs.cache-hit }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²ç”¨äºåˆ†æ

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: ç¼“å­˜ä¾èµ–
        id: cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.pnpm-store
            **/node_modules
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: ESLint ä»£ç æ£€æŸ¥
        run: pnpm run lint
        continue-on-error: true

      - name: TypeScript ç±»å‹æ£€æŸ¥
        run: |
          echo "æ£€æŸ¥ Web åº”ç”¨ç±»å‹..."
          cd apps/web
          pnpm run type-check || npx tsc --noEmit
          cd ../..

          echo "æ£€æŸ¥ Agent åº”ç”¨ç±»å‹..."
          cd apps/agent
          pnpm run type-check || npx tsc --noEmit
        continue-on-error: true

  # æ„å»ºæ£€æŸ¥
  build-check:
    name: æ„å»ºæ£€æŸ¥
    runs-on: ubuntu-latest
    needs: code-quality

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: æ„å»ºé¡¹ç›®
        run: |
          echo "æ„å»º Web åº”ç”¨..."
          cd apps/web
          pnpm run build
          cd ../..

          echo "æ„å»º Agent åº”ç”¨..."
          cd apps/agent
          pnpm run build || echo "Agent æ„å»ºè„šæœ¬ä¸å­˜åœ¨ï¼Œè·³è¿‡"

  # å•å…ƒæµ‹è¯•ï¼ˆé¢„ç•™ï¼‰
  unit-tests:
    name: å•å…ƒæµ‹è¯•
    runs-on: ubuntu-latest
    needs: code-quality
    if: false # æš‚æ—¶ç¦ç”¨ï¼Œç­‰æ·»åŠ æµ‹è¯•åå¯ç”¨

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"

      - name: å®‰è£…ä¾èµ–
        run: pnpm install --frozen-lockfile

      - name: è¿è¡Œæµ‹è¯•
        run: pnpm test -- --coverage

      - name: ä¸Šä¼ æµ‹è¯•è¦†ç›–ç‡
        uses: codecov/codecov-action@v3
        if: always()
        with:
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella

  # Web åº”ç”¨ Docker æ„å»ºå’Œæ¨é€
  build-web:
    name: æ„å»º Web é•œåƒ
    needs: [code-quality]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    outputs:
      image-tag: ${{ steps.set-image-tag.outputs.image-tag }}
      image-digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: é…ç½® Docker é•œåƒæº
        run: |
          mkdir -p ~/.docker
          cat > ~/.docker/daemon.json << 'EOF'
          {
            "registry-mirrors": [
              "https://registry.cn-hangzhou.aliyuncs.com",
              "https://hub-mirror.c.163.com",
              "https://docker.mirrors.ustc.edu.cn"
            ],
            "experimental": false,
            "features": {
              "buildkit": true
            }
          }
          EOF

          echo "Docker é•œåƒæºé…ç½®å®Œæˆ"

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: network=host
          buildkitd-config-inline: |
            [registry."docker.io"]
              mirrors = ["registry.cn-hangzhou.aliyuncs.com", "hub-mirror.c.163.com"]

      - name: ç™»å½•åˆ°é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ALIYUN_REGISTRY }}
          username: ${{ secrets.ALIYUN_REGISTRY_USERNAME }}
          password: ${{ secrets.ALIYUN_REGISTRY_PASSWORD }}

      - name: æå– Web é•œåƒå…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/${{ env.WEB_IMAGE_NAME }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=staging,enable=${{ github.ref == 'refs/heads/develop' }}
            type=ref,event=branch,enable=${{ github.ref != 'refs/heads/main' && github.ref != 'refs/heads/develop' }}
            type=sha,prefix={{branch}}-
          labels: |
            org.opencontainers.image.title=CopilotKit Web
            org.opencontainers.image.description=CopilotKit AMISç¼–è¾‘å™¨Webåº”ç”¨
            org.opencontainers.image.vendor=CopilotKit
            org.opencontainers.image.source=https://github.com/${{ github.repository }}

      - name: æ„å»ºå¹¶æ¨é€ Web Docker é•œåƒ
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/web/Dockerfile
          platforms: "linux/amd64"
          push: ${{ github.event_name != 'pull_request' && (github.event.inputs.push_to_registry != 'false') }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=web
          cache-to: type=gha,mode=max,scope=web
          build-args: |
            NODE_ENV=production
            BUILD_DATE=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.created'] }}
            VCS_REF=${{ github.sha }}

      - name: è®¾ç½®é•œåƒæ ‡ç­¾è¾“å‡º
        id: set-image-tag
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            IMAGE_TAG="${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/${{ env.WEB_IMAGE_NAME }}:latest"
          elif [ "${{ github.ref }}" == "refs/heads/develop" ]; then
            IMAGE_TAG="${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/${{ env.WEB_IMAGE_NAME }}:staging"
          else
            BRANCH_NAME=$(echo "${{ github.ref }}" | sed 's/refs\/heads\///')
            IMAGE_TAG="${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/${{ env.WEB_IMAGE_NAME }}:${BRANCH_NAME}"
          fi
          echo "image-tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "Web é•œåƒæ ‡ç­¾: $IMAGE_TAG"

      - name: Web é•œåƒå®‰å…¨æ‰«æ
        if: github.event_name != 'pull_request'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.set-image-tag.outputs.image-tag }}
          format: "sarif"
          output: "web-security-results.sarif"
        continue-on-error: true

  # Agent åº”ç”¨ Docker æ„å»ºå’Œæ¨é€
  build-agent:
    name: æ„å»º Agent é•œåƒ
    needs: [code-quality]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    outputs:
      image-tag: ${{ steps.set-image-tag.outputs.image-tag }}
      image-digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: é…ç½® Docker é•œåƒæº
        run: |
          mkdir -p ~/.docker
          cat > ~/.docker/daemon.json << 'EOF'
          {
            "registry-mirrors": [
              "https://registry.cn-hangzhou.aliyuncs.com",
              "https://hub-mirror.c.163.com",
              "https://docker.mirrors.ustc.edu.cn"
            ],
            "experimental": false,
            "features": {
              "buildkit": true
            }
          }
          EOF

          echo "Docker é•œåƒæºé…ç½®å®Œæˆ"

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: network=host
          buildkitd-config-inline: |
            [registry."docker.io"]
              mirrors = ["registry.cn-hangzhou.aliyuncs.com", "hub-mirror.c.163.com"]

      - name: ç™»å½•åˆ°é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ALIYUN_REGISTRY }}
          username: ${{ secrets.ALIYUN_REGISTRY_USERNAME }}
          password: ${{ secrets.ALIYUN_REGISTRY_PASSWORD }}

      - name: æ£€æŸ¥ Agent Dockerfile
        id: check-dockerfile
        run: |
          if [ -f "apps/agent/Dockerfile" ]; then
            echo "dockerfile-exists=true" >> $GITHUB_OUTPUT
            echo "âœ… Agent Dockerfile å­˜åœ¨"
          else
            echo "dockerfile-exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Agent Dockerfile ä¸å­˜åœ¨ï¼Œå°†è·³è¿‡æ„å»º"
          fi

      - name: æå– Agent é•œåƒå…ƒæ•°æ®
        if: steps.check-dockerfile.outputs.dockerfile-exists == 'true'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/${{ env.AGENT_IMAGE_NAME }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=staging,enable=${{ github.ref == 'refs/heads/develop' }}
            type=ref,event=branch,enable=${{ github.ref != 'refs/heads/main' && github.ref != 'refs/heads/develop' }}
            type=sha,prefix={{branch}}-
          labels: |
            org.opencontainers.image.title=CopilotKit Agent
            org.opencontainers.image.description=CopilotKit AMISæ™ºèƒ½ä»£ç†æœåŠ¡
            org.opencontainers.image.vendor=CopilotKit
            org.opencontainers.image.source=https://github.com/${{ github.repository }}

      - name: æ„å»ºå¹¶æ¨é€ Agent Docker é•œåƒ
        if: steps.check-dockerfile.outputs.dockerfile-exists == 'true'
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: apps/agent/Dockerfile
          platforms: "linux/amd64"
          push: ${{ github.event_name != 'pull_request' && (github.event.inputs.push_to_registry != 'false') }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=agent
          cache-to: type=gha,mode=max,scope=agent
          build-args: |
            NODE_ENV=production
            BUILD_DATE=${{ fromJSON(steps.meta.outputs.json).labels['org.opencontainers.image.created'] }}
            VCS_REF=${{ github.sha }}

      - name: è®¾ç½®é•œåƒæ ‡ç­¾è¾“å‡º
        if: steps.check-dockerfile.outputs.dockerfile-exists == 'true'
        id: set-image-tag
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            IMAGE_TAG="${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/${{ env.AGENT_IMAGE_NAME }}:latest"
          elif [ "${{ github.ref }}" == "refs/heads/develop" ]; then
            IMAGE_TAG="${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/${{ env.AGENT_IMAGE_NAME }}:staging"
          else
            BRANCH_NAME=$(echo "${{ github.ref }}" | sed 's/refs\/heads\///')
            IMAGE_TAG="${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/${{ env.AGENT_IMAGE_NAME }}:${BRANCH_NAME}"
          fi
          echo "image-tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "Agent é•œåƒæ ‡ç­¾: $IMAGE_TAG"

      - name: Agent é•œåƒå®‰å…¨æ‰«æ
        if: steps.check-dockerfile.outputs.dockerfile-exists == 'true' && github.event_name != 'pull_request'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.set-image-tag.outputs.image-tag }}
          format: "sarif"
          output: "agent-security-results.sarif"
        continue-on-error: true

  # é•œåƒæµ‹è¯•
  test-images:
    name: æµ‹è¯• Docker é•œåƒ
    runs-on: ubuntu-latest
    needs: [build-web, build-agent]
    if: github.event_name != 'pull_request' && always()

    steps:
      - name: é…ç½® Docker é•œåƒæº
        run: |
          mkdir -p ~/.docker
          cat > ~/.docker/daemon.json << 'EOF'
          {
            "registry-mirrors": [
              "https://registry.cn-hangzhou.aliyuncs.com",
              "https://hub-mirror.c.163.com",
              "https://docker.mirrors.ustc.edu.cn"
            ],
            "experimental": false,
            "features": {
              "buildkit": true
            }
          }
          EOF

          echo "Docker é•œåƒæºé…ç½®å®Œæˆ"

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½•åˆ°é˜¿é‡Œäº‘æ³¨å†Œè¡¨
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ALIYUN_REGISTRY }}
          username: ${{ secrets.ALIYUN_REGISTRY_USERNAME }}
          password: ${{ secrets.ALIYUN_REGISTRY_PASSWORD }}

      - name: æµ‹è¯• Web é•œåƒå¯åŠ¨
        if: needs.build-web.result == 'success'
        run: |
          WEB_IMAGE_TAG="${{ needs.build-web.outputs.image-tag }}"
          echo "æµ‹è¯• Web é•œåƒ: $WEB_IMAGE_TAG"

          docker run --rm -d --name test-web-container \
            -p 3000:3000 \
            -e NODE_ENV=production \
            "$WEB_IMAGE_TAG"

          echo "ç­‰å¾… Web å®¹å™¨å¯åŠ¨..."
          sleep 45

          if docker ps --filter "name=test-web-container" --format "table {{.Names}}" | grep -q test-web-container; then
            echo "âœ… Web å®¹å™¨å¯åŠ¨æˆåŠŸ"
            
            echo "å®¹å™¨æ—¥å¿—:"
            docker logs test-web-container --tail 20
            
            echo "æµ‹è¯• Web æœåŠ¡..."
            for i in {1..3}; do
              if curl -f -s --connect-timeout 15 --max-time 30 http://localhost:3000/ > /dev/null 2>&1; then
                echo "âœ… Web æœåŠ¡å“åº”æ­£å¸¸ (ç¬¬${i}æ¬¡å°è¯•)"
                break
              else
                echo "âš ï¸ Web æœåŠ¡æµ‹è¯•å¤±è´¥ (ç¬¬${i}æ¬¡å°è¯•)ï¼Œç­‰å¾…15ç§’åé‡è¯•..."
                sleep 15
              fi
              
              if [ $i -eq 3 ]; then
                echo "âš ï¸ Web æœåŠ¡æœ€ç»ˆæµ‹è¯•å¤±è´¥ï¼Œä½†å®¹å™¨æ­£åœ¨è¿è¡Œ"
                echo "å®Œæ•´å®¹å™¨æ—¥å¿—:"
                docker logs test-web-container
              fi
            done
          else
            echo "âŒ Web å®¹å™¨å¯åŠ¨å¤±è´¥"
            docker ps -a --filter "name=test-web-container"
            docker logs test-web-container 2>&1 || echo "æ— æ³•è·å–å®¹å™¨æ—¥å¿—"
            exit 1
          fi

          docker stop test-web-container 2>/dev/null || echo "å®¹å™¨å·²åœæ­¢"

      - name: æµ‹è¯• Agent é•œåƒå¯åŠ¨
        if: needs.build-agent.result == 'success' && needs.build-agent.outputs.image-tag != ''
        run: |
          AGENT_IMAGE_TAG="${{ needs.build-agent.outputs.image-tag }}"
          echo "æµ‹è¯• Agent é•œåƒ: $AGENT_IMAGE_TAG"

          docker run --rm -d --name test-agent-container \
            -p 8123:8123 \
            "$AGENT_IMAGE_TAG"

          echo "ç­‰å¾… Agent å®¹å™¨å¯åŠ¨..."
          sleep 30

          if docker ps --filter "name=test-agent-container" --format "table {{.Names}}" | grep -q test-agent-container; then
            echo "âœ… Agent å®¹å™¨å¯åŠ¨æˆåŠŸ"
            
            echo "å®¹å™¨æ—¥å¿—:"
            docker logs test-agent-container --tail 20
          else
            echo "âŒ Agent å®¹å™¨å¯åŠ¨å¤±è´¥"
            docker ps -a --filter "name=test-agent-container"
            docker logs test-agent-container 2>&1 || echo "æ— æ³•è·å–å®¹å™¨æ—¥å¿—"
          fi

          docker stop test-agent-container 2>/dev/null || echo "å®¹å™¨å·²åœæ­¢"

  # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  deploy:
    name: éƒ¨ç½²åº”ç”¨
    needs: [build-web, build-agent, test-images]
    runs-on: ubuntu-latest
    if: |
      (github.ref == 'refs/heads/main') ||
      (github.ref == 'refs/heads/develop') ||
      (github.event_name == 'workflow_dispatch')
    environment:
      name: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
      url: ${{ env.DEPLOY_URL }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½®éƒ¨ç½²ç¯å¢ƒå˜é‡
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "DEPLOY_ENV=production" >> $GITHUB_ENV
            echo "IMAGE_TAG=latest" >> $GITHUB_ENV
          else
            echo "DEPLOY_ENV=staging" >> $GITHUB_ENV
            echo "IMAGE_TAG=staging" >> $GITHUB_ENV
          fi

          DEPLOY_SERVICES="${{ github.event.inputs.deploy_services || 'all' }}"
          case "$DEPLOY_SERVICES" in
            "web")
              echo "COMPOSE_FILE=docker-compose.prod.web.yml" >> $GITHUB_ENV
              echo "DEPLOY_SERVICES=web" >> $GITHUB_ENV
              ;;
            "agent")
              echo "COMPOSE_FILE=docker-compose.prod.agent.yml" >> $GITHUB_ENV
              echo "DEPLOY_SERVICES=agent" >> $GITHUB_ENV
              ;;
            *)
              echo "COMPOSE_FILE=docker-compose.prod.yml" >> $GITHUB_ENV
              echo "DEPLOY_SERVICES=all" >> $GITHUB_ENV
              ;;
          esac

      - name: å‡†å¤‡éƒ¨ç½²é…ç½®
        run: |
          cat > .env.production << 'ENVEOF'
          NODE_ENV=production
          NEXT_PUBLIC_API_BASE_URL=${{ env.API_URL }}
          ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_API_URL=${{ secrets.ANTHROPIC_API_URL }}
          LANGSMITH_TRACING=${{ secrets.LANGSMITH_TRACING }}
          LANGSMITH_ENDPOINT=${{ secrets.LANGSMITH_ENDPOINT }}
          LANGSMITH_API_KEY=${{ secrets.LANGSMITH_API_KEY }}
          LANGSMITH_PROJECT=${{ secrets.LANGSMITH_PROJECT }}
          ALIYUN_REGISTRY=${{ env.ALIYUN_REGISTRY }}
          ALIYUN_NAMESPACE=${{ env.ALIYUN_NAMESPACE }}
          WEB_IMAGE_NAME=${{ env.WEB_IMAGE_NAME }}
          AGENT_IMAGE_NAME=${{ env.AGENT_IMAGE_NAME }}
          IMAGE_TAG=${{ env.IMAGE_TAG }}
          ENVEOF

          echo "âœ… .env.production æ–‡ä»¶å·²åˆ›å»º"

      - name: è®¾ç½®SSHå¯†é’¥
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      - name: éƒ¨ç½²åº”ç”¨åˆ°æœåŠ¡å™¨
        run: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²åˆ° ${{ env.DEPLOY_ENV }} ç¯å¢ƒ..."

          if [ ! -f .env.production ]; then
            echo "âŒ æœ¬åœ° .env.production æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi

          if [ ! -f ${{ env.COMPOSE_FILE }} ]; then
            echo "âš ï¸ æœ¬åœ° ${{ env.COMPOSE_FILE }} æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤é…ç½®"
          fi

          DEPLOY_PATH="${{ secrets.DEPLOY_PATH }}"
          if [ -z "$DEPLOY_PATH" ]; then
            DEPLOY_PATH="/opt/copilotkit"
            echo "âš ï¸ DEPLOY_PATH æœªè®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤è·¯å¾„: $DEPLOY_PATH"
          fi

          echo "ğŸ“¤ ä¸Šä¼ é…ç½®æ–‡ä»¶åˆ°æœåŠ¡å™¨..."
          # åœ¨è¿œç¨‹æœåŠ¡å™¨ä¸Šåˆ›å»ºç›®å½•
          ssh -i ~/.ssh/deploy_key ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} "mkdir -p $DEPLOY_PATH"

          scp -i ~/.ssh/deploy_key .env.production ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:$DEPLOY_PATH/
          scp -i ~/.ssh/deploy_key ${{ env.COMPOSE_FILE }} ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:$DEPLOY_PATH/ || echo "è·³è¿‡ compose æ–‡ä»¶ä¸Šä¼ "

          ssh -i ~/.ssh/deploy_key ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
            cd ${{ secrets.DEPLOY_PATH }}

            echo "1. ç™»å½•é˜¿é‡Œäº‘é•œåƒæœåŠ¡..."
            echo "${{ secrets.ALIYUN_REGISTRY_PASSWORD }}" | docker login --username ${{ secrets.ALIYUN_REGISTRY_USERNAME }} --password-stdin ${{ env.ALIYUN_REGISTRY }}

            echo "2. ç¡®ä¿Dockerç½‘ç»œå­˜åœ¨..."
            docker network create copilotkit-network 2>/dev/null || echo "ç½‘ç»œå·²å­˜åœ¨"

            echo "3. æ‹‰å–æœ€æ–°é•œåƒ..."
            docker pull ${{ needs.build-web.outputs.image-tag }}
            [ -n "${{ needs.build-agent.outputs.image-tag }}" ] && docker pull ${{ needs.build-agent.outputs.image-tag }} || echo "è·³è¿‡ Agent é•œåƒæ‹‰å–"

            echo "4. åœæ­¢æ—§æœåŠ¡..."
            docker-compose -f $(basename ${{ env.COMPOSE_FILE }}) --env-file .env.production stop || true
            docker-compose -f $(basename ${{ env.COMPOSE_FILE }}) --env-file .env.production rm -f || true

            echo "5. æ¸…ç†ç›¸å…³èµ„æº..."
            docker container ls -a --filter "name=copilotkit-" --format "{{.ID}}" | xargs -r docker rm -f || true

            echo "6. å¯åŠ¨æœåŠ¡..."
            docker-compose -f $(basename ${{ env.COMPOSE_FILE }}) --env-file .env.production up -d --force-recreate

            echo "7. æ™ºèƒ½æ¸…ç†æ—§é•œåƒ..."
            docker images "${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/${{ env.WEB_IMAGE_NAME }}" --format "{{.ID}} {{.CreatedAt}}" | sort -k2 -r | tail -n +4 | awk '{print $1}' | xargs -r docker rmi -f || echo "æ²¡æœ‰æ—§é•œåƒéœ€è¦æ¸…ç†"
            docker images "${{ env.ALIYUN_REGISTRY }}/${{ env.ALIYUN_NAMESPACE }}/${{ env.AGENT_IMAGE_NAME }}" --format "{{.ID}} {{.CreatedAt}}" | sort -k2 -r | tail -n +4 | awk '{print $1}' | xargs -r docker rmi -f || echo "æ²¡æœ‰æ—§é•œåƒéœ€è¦æ¸…ç†"
            docker images --filter "dangling=true" --filter "label=org.opencontainers.image.vendor=CopilotKit" -q | xargs -r docker rmi -f || echo "æ²¡æœ‰æ— æ ‡ç­¾é•œåƒéœ€è¦æ¸…ç†"

            echo "âœ… éƒ¨ç½²å®Œæˆ"
          EOF

      - name: å¥åº·æ£€æŸ¥
        run: |
          echo "ğŸ” æ‰§è¡Œå¥åº·æ£€æŸ¥..."
          sleep 60

          WEB_STATUS=$(ssh -i ~/.ssh/deploy_key ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} \
            "cd ${{ secrets.DEPLOY_PATH }} && docker-compose ps web | grep -c 'Up'" 2>/dev/null || echo "0")

          if [ "${WEB_STATUS}" -gt 0 ]; then
            echo "âœ… Web å®¹å™¨è¿è¡Œæ­£å¸¸"
            
            if curl -f -s --connect-timeout 15 --max-time 45 ${{ env.DEPLOY_URL }}/ > /dev/null 2>&1; then
              echo "âœ… Web æœåŠ¡æ­£å¸¸"
            else
              echo "âš ï¸ Web æœåŠ¡æ£€æŸ¥å¤±è´¥ï¼Œä½†å®¹å™¨æ­£åœ¨è¿è¡Œ"
            fi
            
            echo "âœ… éƒ¨ç½²éªŒè¯å®Œæˆ"
          else
            echo "âš ï¸ Web å®¹å™¨çŠ¶æ€æ£€æŸ¥å¤±è´¥"
          fi

      - name: é€šçŸ¥éƒ¨ç½²ç»“æœ
        if: always()
        run: |
          echo "## éƒ¨ç½²ç»“æœ ğŸ“‹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… **åº”ç”¨éƒ¨ç½²æˆåŠŸ**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **ç¯å¢ƒ**: ${{ env.DEPLOY_ENV }}" >> $GITHUB_STEP_SUMMARY
            echo "- **éƒ¨ç½²æœåŠ¡**: ${{ env.DEPLOY_SERVICES }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Webåœ°å€**: [${{ env.DEPLOY_URL }}](${{ env.DEPLOY_URL }})" >> $GITHUB_STEP_SUMMARY
            echo "- **é•œåƒæ ‡ç­¾**: ${{ env.IMAGE_TAG }}" >> $GITHUB_STEP_SUMMARY
            echo "- **éƒ¨ç½²æ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **åº”ç”¨éƒ¨ç½²å¤±è´¥**" >> $GITHUB_STEP_SUMMARY
          fi
